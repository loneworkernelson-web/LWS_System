<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LWS - Deployment Setup Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        .step { display: none; }
        .step.active { display: block; }
        .step-nav button {
            transition: background-color 0.2s, color 0.2s;
        }
        .step-nav button.current {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
        }
        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #4b5563;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .copy-btn:hover { background-color: #6b7280; }
        .copy-btn.copied { background-color: #10b981; }
        /* Style for bolding key terms */
        strong { color: #60a5fa; /* A lighter blue for emphasis */ font-weight: 600; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-gray-800 rounded-lg shadow-xl overflow-hidden">
        
        <!-- Header / Step Navigation -->
        <div class="bg-gray-900 p-4 border-b border-gray-700">
            <h1 class="text-2xl font-bold text-blue-400 text-center">Lone Worker Safety System - Setup Tool</h1>
        </div>
        <div class="step-nav flex flex-wrap justify-center bg-gray-700 p-2 shadow-inner">
            <button type="button" id="nav1" onclick="showStep(1)" class="current px-3 py-2 text-sm font-medium rounded-md m-1" disabled>Step 1: Welcome</button>
            <button type="button" id="nav2" onclick="showStep(2)" class="px-3 py-2 text-sm font-medium rounded-md m-1 text-gray-400" disabled>Step 2: Sheet Setup</button>
            <button type="button" id="nav3" onclick="showStep(3)" class="px-3 py-2 text-sm font-medium rounded-md m-1 text-gray-400" disabled>Step 3: Deploy Script</button>
            <button type="button" id="nav4" onclick="showStep(4)" class="px-3 py-2 text-sm font-medium rounded-md m-1 text-gray-400" disabled>Step 4: Configure Apps</button>
            <button type="button" id="nav5" onclick="showStep(5)" class="px-3 py-2 text-sm font-medium rounded-md m-1 text-gray-400" disabled>Step 5: Download</button>
        </div>
        
        <div class="p-6 md:p-8">
            <!-- Step 1: Welcome -->
            <div id="step1" class="step active">
                <h2 class="text-xl font-semibold mb-4 text-blue-300">Welcome to the LWS Setup Wizard</h2>
                <p class="text-gray-300 mb-4">This tool will guide you through creating and customizing your Lone Worker Safety system. It will generate a <strong>`.zip`</strong> file containing the final, ready-to-host applications for your workers and monitors.</p>
                <p class="text-gray-300 mb-6">Follow the steps in order. This page will fetch the necessary template files from this repository to build your custom package.</p>
                <button type="button" onclick="nextStep()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Start Setup</button>
            </div>

            <!-- Step 2: Google Sheet Setup -->
            <div id="step2" class="step">
                <h2 class="text-xl font-semibold mb-4 text-blue-300">Step 2: Set Up Your Google Sheet</h2>
                 <ol class="list-decimal list-inside text-gray-300 space-y-3 mb-6">
                    <li>Go to <a href="https://sheets.new" target="_blank" class="text-blue-400 hover:underline"><strong>sheets.new</strong></a> to create a new, blank Google Sheet.</li>
                    <li>Click the button below to copy the required spreadsheet <strong>headers</strong>.</li>
                    <li>In your new sheet, click <strong>once</strong> on cell <strong>A1</strong>.</li>
                    <li><strong>Paste</strong> the copied text. It will appear as one long line in cell A1.</li>
                    <li>With cell A1 still selected, go to the menu: <strong>Data</strong> > <strong>Split text to columns</strong>.</li>
                    <li>If prompted for a separator, choose <strong>Comma</strong>. The headers should now be correctly split across row 1 (A1 to R1).</li>
                </ol>
                <div class="relative bg-gray-900 rounded-lg p-4 font-mono text-sm text-gray-400 pr-16 mb-4">
                    <button type="button" id="copyHeadersBtn" onclick="copyToClipboard('headersText', this)" class="copy-btn">Copy</button>
                    <p id="headersText" class="overflow-x-auto">Date,Worker Name,Worker Phone Number,Emergency Contact Name,Emergency Contact Number,Emergency Contact Email,Escalation Contact Name,Escalation Contact Number,Escalation Contact Email,Location Name,Location Address,Arrival Time,Anticipated Departure Time,Actual Departure Time,Alarm Status,Notes,Last Known GPS,GPS Timestamp</p>
                </div>
                <button type="button" onclick="nextStep()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Next Step</button>
            </div>

            <!-- Step 3: Deploy Google Apps Script -->
            <div id="step3" class="step">
                <h2 class="text-xl font-semibold mb-4 text-blue-300">Step 3: Deploy the Backend Script</h2>
                <ol class="list-decimal list-inside text-gray-300 space-y-3 mb-6">
                    <li>In your Google Sheet, click <strong>`Extensions`</strong> > <strong>`Apps Script`</strong>.</li>
                    <li>Delete any code in the <strong>`Code.gs`</strong> file.</li>
                    <li><strong>Create a Secret Key:</strong> Enter a strong, private password in the box below. This will be automatically injected into the script code for you.</li>
                    
                    <div class="mb-4 ml-6"> 
                        <label for="secretKeyStep3" class="block text-sm font-medium text-gray-300">Create a Secret Key</label>
                        <input type="password" id="secretKeyStep3" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter a strong, private password">
                    </div>

                    <li>Click the <strong>"Copy Script"</strong> button below. The complete, customized code (with your key included) will be copied to your clipboard.</li>
                    <li><strong>Paste</strong> the copied code into the empty <strong>`Code.gs`</strong> editor.</li>
                    <li>Click the <strong>`Deploy`</strong> button (top right), select <strong>`New deployment`</strong>.
                        <ul class="list-disc list-inside ml-6 mt-2 p-2 bg-gray-700 rounded-md">
                            <li>Click the Gear icon for "Select type" and choose <strong>`Web app`</strong>.</li>
                            <li>For "Execute as", select <strong>`Me`</strong>.</li>
                            <li>For "Who has access", select <strong>`Anyone`</strong>.</li>
                            <li>Click <strong>`Deploy`</strong>.</li>
                        </ul>
                    </li>
                    <li><strong>Authorize</strong> the script (click "Authorize access", choose your account, click "Advanced", then "Go to... (unsafe)", and "Allow").</li>
                    <li>After deploying, **copy the "Web app URL"**. You will need it in the next step.</li>
                    <li>Finally, set up the <strong>trigger</strong>:
                        <ul class="list-disc list-inside ml-6 mt-2 p-2 bg-gray-700 rounded-md">
                            <li>Click the "Triggers" icon (alarm clock) on the left.</li>
                            <li>Click <strong>`Add Trigger`</strong>.</li>
                            <li>Set function to <strong>`checkOverdueWorkers`</strong>, source to <strong>`Time-driven`</strong>, type to <strong>`Minutes timer`</strong>, and interval to <strong>`Every 5 minutes`</strong>. Click <strong>`Save`</strong>.</li>
                        </ul>
                    </li>
                </ol>

                <div class="relative bg-gray-900 rounded-lg mb-4 h-64 overflow-y-auto">
                    <button type="button" id="copyScriptBtn" onclick="copyInjectedScript(this)" class="copy-btn z-10">Copy Script</button>
                    <pre id="scriptPreview" class="p-4 text-xs text-gray-400">Loading script preview...</pre>
                </div>
                <button type="button" onclick="nextStep()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Next Step</button>
            </div>

            <!-- Step 4: Configure Apps -->
            <div id="step4" class="step">
                <h2 class="text-xl font-semibold mb-4 text-blue-300">Step 4: Configure Your Applications</h2>
                <p class="text-gray-300 mb-6">Enter the values you just created. This will inject them into the final app files, removing the need for manual setup by your users.</p>
                <div class="space-y-4">
                    <div>
                        <label for="scriptUrl" class="block text-sm font-medium text-gray-300">Web App URL</label>
                        <input type="url" id="scriptUrl" oninput="validateUrl(this)" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Paste the Web app URL from Step 3">
                    </div>
                    <div>
                        <label for="secretKey" class="block text-sm font-medium text-gray-300">Secret Key</label>
                        <input type="text" id="secretKey" class="mt-1 block w-full bg-gray-600 border border-gray-500 rounded-md shadow-sm py-2 px-3 text-gray-400 focus:outline-none" readonly>
                        <p class="text-xs text-gray-400 mt-1">This is auto-filled from Step 3 for confirmation.</p>
                    </div>
                    <div>
                        <label for="firstAlert" class="block text-sm font-medium text-gray-300">First Overdue Alert (Minutes)</label>
                        <input type="number" id="firstAlert" value="15" min="1" class="mt-1 block w-48 bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-400 mt-1">Time a worker is overdue before the Worker App sends an 'ALERT SENT' status (and the backend sends <strong>`EMAIL_1_SENT`</strong>). 15 minutes is recommended.</p>
                    </div>
                    <div class="flex items-center">
                        <input id="enableCheckin" type="checkbox" class="h-4 w-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <label for="enableCheckin" class="ml-2 block text-sm font-medium text-gray-300">Enable "Are You OK?" Check-ins (Optional)</label>
                    </div>
                     <div id="checkinIntervalDiv" class="hidden ml-6"> {/* Indented and initially hidden */}
                        <label for="checkinInterval" class="block text-sm font-medium text-gray-300">Check-in Interval (Minutes)</label>
                        <input type="number" id="checkinInterval" value="30" min="5" class="mt-1 block w-48 bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-400 mt-1">If check-ins are enabled, how often should the worker be prompted? (e.g., 30)</p>
                    </div>
                     <div>
                        <label for="logoUrl" class="block text-sm font-medium text-gray-300">Company Logo URL (Optional)</label>
                        <input type="url" id="logoUrl" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="https://your-logo.com/image.png">
                        <p class="text-xs text-gray-400 mt-1">If provided, this will replace the default icon for the Worker PWA.</p>
                    </div>
                </div>
                <button type="button" onclick="testAndProceed()" class="mt-8 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Test Connection & Proceed</button>
                <p id="testStatus" class="text-center text-yellow-400 mt-4 h-4"></p>
            </div>

            <!-- Step 5: Download -->
            <div id="step5" class="step">
                <h2 class="text-xl font-semibold mb-4 text-green-400">Success!</h2>
                <p class="text-gray-300 mb-6">Your configuration is correct. The system is ready to be packaged. Click the button below to generate and download a <strong>`.zip`</strong> file containing your customized applications.</p>
                <button type="button" id="downloadBtn" onclick="generateZip()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg">Generate & Download .zip Package</button>
                <div id="zipStatus" class="text-center text-gray-400 mt-4"></div>
            </div>
        </div>
    </div>

<script>
    let currentStep = 1;
    const templates = {};
    const config = {
        secretKey: ""
    };

    // --- Template Fetching ---
    window.onload = async () => {
        // --- FIXED FETCH URL CONSTRUCTION ---
        const baseUrl = window.location.href; // Get the full URL of the setup.html page
        const fetchTemplate = async (fileName) => {
            // Construct URL relative to the current page's location
            const templateUrl = new URL(`templates/${fileName}`, baseUrl).href; 
            console.log(`Fetching: ${templateUrl}`); // Log the URL being fetched
            const response = await fetch(templateUrl);
            if (!response.ok) {
                throw new Error(`Failed to load ${fileName} from ${templateUrl} - Status: ${response.status}`);
            }
            const text = await response.text();
            templates[fileName] = text;
        };
        // --- END FIXED FETCH URL ---

        try {
            const templateFiles = [
                'apps_script_template.txt',
                'worker_app_template.txt',
                'monitor_app_template.txt',
                'manifest.json',
                'sw.js',
                'Administrator Setup Guide.md',
                'Installer Creation Guide.md',
                'Promotional Blurb.md'
            ];
            // Fetch sequentially for easier debugging if one fails
            for (const file of templateFiles) {
                await fetchTemplate(file);
            }
            
            console.log('All templates loaded successfully.');
            
            // Make sure script preview exists before setting text
            const scriptPreviewEl = document.getElementById('scriptPreview');
            if (scriptPreviewEl && templates['apps_script_template.txt']) {
                scriptPreviewEl.textContent = templates['apps_script_template.txt'];
            } else {
                 console.warn("Script preview element or template not found after load.");
            }
            // Add listener to show/hide interval input based on checkbox
            const enableCheckinEl = document.getElementById('enableCheckin');
            const checkinIntervalDivEl = document.getElementById('checkinIntervalDiv');
            if (enableCheckinEl && checkinIntervalDivEl) {
                 enableCheckinEl.addEventListener('change', (event) => {
                    if (event.target.checked) {
                        checkinIntervalDivEl.classList.remove('hidden');
                    } else {
                         checkinIntervalDivEl.classList.add('hidden');
                    }
                 });
            } else {
                 console.warn("Checkin elements not found for event listener setup.");
            }

        } catch (error) {
            console.error("Template Loading Error:", error); // Log the specific error
            alert(`Error: Could not load template files. ${error.message}. Please ensure the 'templates' folder exists in the same directory as setup.html and contains all required files. Check the browser console (F12) for more details.`);
            // Disable further interaction if templates fail to load
            document.querySelectorAll('button').forEach(btn => btn.disabled = true);
        }
    };

    // --- Navigation ---
    function showStep(step) {
        // Ensure elements exist before trying to modify them
        document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
        const stepEl = document.getElementById(`step${step}`);
        if (stepEl) stepEl.classList.add('active');
        else console.error(`showStep: Could not find step element 'step${step}'`);
        
        document.querySelectorAll('.step-nav button').forEach(el => el.classList.remove('current'));
        const navEl = document.getElementById(`nav${step}`);
        if (navEl) navEl.classList.add('current');
        else console.error(`showStep: Could not find nav element 'nav${step}'`);
        
        currentStep = step;

        // Auto-fill Step 4's key field when we arrive
        if (step === 4) {
             const secretKeyEl = document.getElementById('secretKey');
             if (secretKeyEl) secretKeyEl.value = config.secretKey;
             else console.error(`showStep: Could not find secretKey element in step 4`);
        }
    }

    function nextStep() {
        // When leaving Step 3, save the key
        if (currentStep === 3) {
            const keyInput = document.getElementById('secretKeyStep3');
            if (!keyInput || !keyInput.value) {
                alert("Please enter a Secret Key before proceeding.");
                return; // GUARD CLAUSE
            }
            config.secretKey = keyInput.value;
        }

        if (currentStep < 5) {
            const nextNav = document.getElementById(`nav${currentStep + 1}`);
            if (nextNav) {
                nextNav.disabled = false;
                nextNav.classList.remove('text-gray-400');
            } else {
                 console.error(`nextStep: Could not find next nav element 'nav${currentStep + 1}'`);
            }
            showStep(currentStep + 1);
        }
    }

    // --- Utilities ---
    function copyToClipboard(elementId, button) {
        const textEl = document.getElementById(elementId);
        if (!textEl || !navigator.clipboard) {
            alert('Clipboard API not available.');
             console.error('Clipboard API not available or element not found:', elementId);
            return;
        }
        const text = textEl.innerText;
        navigator.clipboard.writeText(text).then(() => {
            button.innerText = 'Copied!';
            button.classList.add('copied');
            setTimeout(() => {
                button.innerText = 'Copy';
                button.classList.remove('copied');
            }, 2000);
        }).catch(err => {
            alert('Failed to copy.');
            console.error('Clipboard copy failed:', err);
        });
    }

    function copyInjectedScript(button) {
        const keyInput = document.getElementById('secretKeyStep3');
        const key = keyInput ? keyInput.value : '';
        if (!key) {
            alert("Please enter a Secret Key in the box above first.");
            return;
        }

        const template = templates['apps_script_template.txt'];
        if (!template) {
            alert('Error: Script template not loaded yet. Cannot copy.');
            console.error('copyInjectedScript: apps_script_template not loaded.');
            return;
        }
        
        const injectedScript = template.replace('YOUR_SECRET_KEY_HERE', key);

        if (!navigator.clipboard) {
            alert('Clipboard API not available.');
            console.error('Clipboard API not available.');
            return;
        }
        navigator.clipboard.writeText(injectedScript).then(() => {
            button.innerText = 'Copied!';
            button.classList.add('copied');
            setTimeout(() => {
                button.innerText = 'Copy Script';
                button.classList.remove('copied');
            }, 2000);
        }).catch(err => {
            alert('Failed to copy.');
             console.error('Clipboard copy failed:', err);
        });
    }

    function validateUrl(input) {
         if (!input) return; // Add check
        const urlPattern = /^https:\/\/script\.google\.com\/macros\/s\/.*\/exec$/;
        if (input.value && !urlPattern.test(input.value)) {
            input.style.borderColor = '#ef4444'; // Red border for error
        } else {
            input.style.borderColor = ''; // Revert to default
        }
    }

    // --- Core Logic ---
    function testAndProceed() {
        const urlInput = document.getElementById('scriptUrl');
        const keyInput = document.getElementById('secretKey'); // Reads from the auto-filled field
        const statusEl = document.getElementById('testStatus');
        
        if (!urlInput || !keyInput || !statusEl) {
             console.error("testAndProceed: Missing required elements.");
             return; 
        }

        const url = urlInput.value;
        const key = keyInput.value; 

        if (!url || !key) {
            statusEl.innerText = 'Please fill in both the URL and Secret Key.';
            return;
        }

        // Run validation one last time before testing
        validateUrl(urlInput);
        if (urlInput.style.borderColor) {
             statusEl.innerText = 'The URL format appears to be incorrect.';
             return;
        }

        statusEl.innerText = 'Testing connection...';

        const script = document.createElement('script');
        const callbackName = 'jsonp_callback_' + Date.now();
        let timer;

        // Cleanup function to remove script and callback
        const cleanupJsonp = () => {
             clearTimeout(timer);
             delete window[callbackName];
             if(document.body.contains(script)) {
                 document.body.removeChild(script);
             }
        };

        window[callbackName] = function(data) {
            cleanupJsonp();
            if (data.status === 'error' && data.message.includes('Access Denied')) {
                statusEl.innerText = 'Error: Access Denied. Your Secret Key is incorrect.';
            } else if (Array.isArray(data)) {
                statusEl.innerText = 'Success! Connection verified.';
                nextStep();
            } else {
                statusEl.innerText = 'Error: Received unexpected data from the script.';
                 console.error("JSONP Response Error:", data);
            }
        };

        script.src = url + '?callback=' + callbackName + '&token=' + encodeURIComponent(key);
        script.onerror = () => {
            cleanupJsonp();
            statusEl.innerText = 'Error: Could not connect. Check the Web App URL, network, and CORS settings.';
             console.error("JSONP Script onerror triggered.");
        };
        
        timer = setTimeout(() => {
            // Manually trigger error if timeout
            if (window[callbackName]) { // Check if callback still exists
                 console.error("JSONP Request Timed Out");
                 cleanupJsonp();
                 statusEl.innerText = 'Error: Connection timed out. Check URL or script deployment.';
            }
        }, 15000); // Increased timeout to 15 seconds

        document.body.appendChild(script);
    }

    async function generateZip() {
        const statusEl = document.getElementById('zipStatus');
        const downloadBtn = document.getElementById('downloadBtn');
        if (!statusEl || !downloadBtn) {
             console.error("generateZip: Missing status or download button element.");
             return; 
        }

        statusEl.innerText = 'Gathering files...';
        downloadBtn.disabled = true;
        downloadBtn.classList.add('bg-gray-500', 'cursor-not-allowed');
        downloadBtn.classList.remove('hover:bg-blue-700');


        try {
            // Check if JSZip is loaded
            if (typeof JSZip === 'undefined') {
                 throw new Error("JSZip library not loaded.");
            }
            const zip = new JSZip();

            // Get form values - Add checks for element existence
            const urlInput = document.getElementById('scriptUrl');
            const keyInput = document.getElementById('secretKey');
            const firstAlertInput = document.getElementById('firstAlert');
            const enableCheckinInput = document.getElementById('enableCheckin');
            const checkinIntervalInput = document.getElementById('checkinInterval');
            const logoUrlInput = document.getElementById('logoUrl');

            if (!urlInput || !keyInput || !firstAlertInput || !enableCheckinInput || !checkinIntervalInput || !logoUrlInput) {
                 throw new Error("One or more configuration input elements are missing in Step 4.");
            }

            const url = urlInput.value;
            const key = keyInput.value; 
            const firstAlert = firstAlertInput.value;
            const checkin = enableCheckinInput.checked;
            const checkinInterval = checkinIntervalInput.value || '30'; // Default to 30 if hidden/empty
            const logoUrl = logoUrlInput.value || 'https://i.postimg.cc/dVmVg3Pn/favicon-logo-for-LWSApp.png'; 
            
            // --- ADD VALIDATION FOR REQUIRED FIELDS ---
            if (!url) throw new Error("Web App URL is required.");
            if (!key) throw new Error("Secret Key is required (should be auto-filled).");
            if (!firstAlert) throw new Error("First Alert time is required.");
            // --- END VALIDATION ---


            // Define required templates for this function
            const requiredTemplates = [
                 'worker_app_template.txt', 
                 'monitor_app_template.txt', 
                 'manifest.json', 
                 'sw.js', 
                 'apps_script_template.txt', 
                 'Administrator Setup Guide.md', 
                 'Installer Creation Guide.md', 
                 'Promotional Blurb.md'
            ];
             // Check if all required templates are loaded
            for (const tpl of requiredTemplates) {
                if (!templates[tpl] || typeof templates[tpl] !== 'string') {
                    throw new Error(`Template file '${tpl}' not loaded or is not text. Cannot generate zip.`);
                }
            }


            // --- 1. Process Worker App ---
            statusEl.innerText = 'Processing Worker App...';
            let workerApp = templates['worker_app_template.txt'];
            workerApp = workerApp.replace(/%%FIRST_ALERT_MINUTES%%/g, firstAlert);
            workerApp = workerApp.replace(/%%CHECKIN_ENABLED%%/g, checkin);
            workerApp = workerApp.replace(/%%CHECKIN_INTERVAL%%/g, checkinInterval);
            workerApp = workerApp.replace(/https:\/\/i\.postimg\.cc\/dVmVg3Pn\/favicon-logo-for-LWSApp\.png/g, logoUrl);
            workerApp = workerApp.replace(/%%GOOGLE_SHEET_URL%%/g, url);
            
            const workerFolder = zip.folder('LoneWorkerApp');
            if (!workerFolder) throw new Error("Could not create worker folder in zip");
            workerFolder.file('index.html', workerApp);
            workerFolder.file('sw.js', templates['sw.js']);

            // --- 2. Process Manifest ---
            let manifest = templates['manifest.json'];
            manifest = manifest.replace(/https:\/\/i\.postimg\.cc\/dVmVg3Pn\/favicon-logo-for-LWSApp\.png/g, logoUrl);
            workerFolder.file('manifest.json', manifest);

            // --- 3. Process Monitor App ---
            statusEl.innerText = 'Processing Monitor App...';
            let monitorApp = templates['monitor_app_template.txt'];
            
            // Use robust comment placeholders
            monitorApp = monitorApp.replace(/<!-- SETUP_PAGE_START -->.*?<!-- SETUP_PAGE_END -->/s, '');
            monitorApp = monitorApp.replace(/<!-- RESET_BUTTON_START -->.*?<!-- RESET_BUTTON_END -->/s, '');
            monitorApp = monitorApp.replace('<div id="dashboardPage" class="h-full flex-col hidden">', '<div id="dashboardPage" class="h-full flex flex-col">');
            
            const loginLogic = `
    sheetUrl = "${url}";
    secretKey = "${key}";
    
    initEventListeners();
    
    // This is the modified init() function logic
    navigate('dashboard');
    fetchData();
    if (pollingInterval) clearInterval(pollingInterval);
    pollingInterval = setInterval(fetchData, 15000);
            `;
            // Use robust comment placeholders for replacement
            monitorApp = monitorApp.replace(/<!-- MONITOR_LOGIN_LOGIC_START -->.*?<!-- MONITOR_LOGIN_LOGIC_END -->/s, loginLogic);
            
            const monitorFolder = zip.folder('MonitoringDashboardApp');
             if (!monitorFolder) throw new Error("Could not create monitor folder in zip");
            monitorFolder.file('index.html', monitorApp);

            // --- 4. Process Apps Script ---
            statusEl.innerText = 'Processing Apps Script file...';
            let appsScript = templates['apps_script_template.txt'];
            appsScript = appsScript.replace('YOUR_SECRET_KEY_HERE', key);
            zip.file('01-PASTE_THIS_INTO_APPS_SCRIPT.txt', appsScript);

            // --- 5. Add Documentation ---
            statusEl.innerText = 'Adding documentation...';
            const docFolder = zip.folder('Documentation');
            if (!docFolder) throw new Error("Could not create documentation folder in zip");
            
            let adminGuide = templates['Administrator Setup Guide.md'];
            
             // Update admin guide regex for multiline and escaped characters
            adminGuide = adminGuide.replace(/find the line `var SECRET_KEY = "YOUR_SECRET_KEY_HERE";` and change it to a \*\*strong, private password\*\*\./, "Enter your desired **Secret Key** in the box provided. The tool will inject this for you.");
            adminGuide = adminGuide.replace(/Paste the \*\*Web app URL\*\* .*? into the first box\.\s*\* Enter the \*\*Secret Key\*\* .*? into the second box\./s, "Paste the **Web app URL** (from the previous step) into the first box.\n* The **Secret Key** field will be auto-filled for you.");
             
            docFolder.file('Administrator Setup Guide.md', adminGuide);
            docFolder.file('Installer Creation Guide.md', templates['Installer Creation Guide.md']);
            docFolder.file('Promotional Blurb.md', templates['Promotional Blurb.md']);

            // --- 6. Generate and Download ---
            statusEl.innerText = 'Generating .zip file...';
            const content = await zip.generateAsync({ type: 'blob' });
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(content);
            a.download = 'LWS_Deployment_Package.zip';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href); // Clean up blob URL

            statusEl.innerText = 'Download complete!';
            

        } catch (error) {
            console.error("Error during zip generation:", error);
            statusEl.innerText = `Error generating zip file: ${error.message}. See console for details.`;
           
        } finally {
             // Ensure button is always re-enabled
             downloadBtn.disabled = false;
             downloadBtn.classList.remove('bg-gray-500', 'cursor-not-allowed');
             downloadBtn.classList.add('hover:bg-blue-700');
        }
    }
</script>
</body>
</html>

